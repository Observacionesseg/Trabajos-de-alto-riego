<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

  <style>
    :root { 
      --azul-orcela: #002349; 
      --azul-accent: #0056b3; 
      --gris-fondo: #f4f7f9;
      --gris-borde: #dee2e6;
    }
    
    body { 
      background-color: var(--gris-fondo); 
      font-family: 'Inter', sans-serif; 
      padding: 40px 0; 
      color: #333;
    }

    .container { max-width: 900px; }

    /* Tarjetas de Sección */
    .seccion-card { 
      background: white; 
      padding: 30px; 
      border-radius: 16px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.05); 
      margin-bottom: 30px; 
      border: 1px solid rgba(0,0,0,0.05);
      border-top: 5px solid var(--azul-orcela); 
    }

    /* Ajustes específicos para Tom Select y que combine con tu diseño */
    .ts-control {
      border-radius: 8px !important;
      padding: 10px 15px !important;
      border: 1px solid var(--gris-borde) !important;
      font-size: 0.9rem !important;
    }
    .ts-wrapper.single .ts-control { background-image: none !important; }
    .ts-dropdown { border-radius: 8px !important; }

    h2 { letter-spacing: -1px; }
    
    h3 { 
      color: var(--azul-orcela); 
      font-size: 1rem; 
      font-weight: 700; 
      text-transform: uppercase; 
      margin-bottom: 25px; 
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h3::after {
      content: "";
      flex: 1;
      height: 1px;
      background: #eee;
    }

    /* Grid de Checklists */
    .grid-checklist { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); 
      gap: 12px; 
    }

    .check-item { 
      background: #ffffff; 
      padding: 12px 15px; 
      border-radius: 10px; 
      border: 1px solid var(--gris-borde); 
      font-size: 0.85rem; 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .check-item:hover {
      border-color: var(--azul-orcela);
      background-color: #f8f9ff;
    }

    .check-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* Filas de Preguntas (Punto 7) */
    .pregunta-row { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 12px 15px; 
      border-radius: 8px;
      margin-bottom: 5px;
      transition: background 0.2s;
    }

    .pregunta-row:nth-child(odd) { background: #fafafa; }
    .pregunta-row:hover { background: #f1f4f8; }

    .pregunta-row span { flex: 1; padding-right: 20px; font-size: 0.9rem; }

    /* Sub-secciones */
    .sub-seccion { 
      margin-left: 15px; 
      border-left: 3px solid #e9ecef; 
      padding-left: 20px; 
      margin-top: 15px; 
      margin-bottom: 20px;
    }

    .hidden { display: none; }

    /* Inputs y Tablas */
    .form-control, .form-select {
      border-radius: 8px;
      padding: 10px 15px;
      border: 1px solid var(--gris-borde);
    }

    .form-control:focus {
      border-color: var(--azul-orcela);
      box-shadow: 0 0 0 0.25rem rgba(0, 35, 73, 0.1);
    }

    .form-control-readonly {
      background-color: #f8f9fa !important;
      font-weight: 700;
      color: var(--azul-orcela);
      border-style: dashed;
    }

    .table { border-radius: 10px; overflow: hidden; font-size: 0.9rem; }
    .table thead { background-color: var(--azul-orcela); color: white; border: none; }

    /* Botón */
    .btn-submit { 
      background: var(--azul-orcela); 
      color: white; 
      padding: 20px; 
      font-weight: 700; 
      width: 100%; 
      border-radius: 12px; 
      border: none; 
      font-size: 1.1rem; 
      margin-bottom: 80px; 
      transition: transform 0.2s, background 0.2s;
      box-shadow: 0 10px 20px rgba(0,35,73,0.2);
    }

    .btn-submit:hover { 
      background: var(--azul-accent); 
      transform: translateY(-2px);
    }

    .btn-submit:active { transform: translateY(0); }
    .btn-submit:disabled { background: #666; cursor: not-allowed; }

    .text-muted-small { font-size: 0.8rem; color: #6c757d; }
  </style>
</head>
<body>

<div class="container">
  <div class="text-center mb-5">
    <h2 style="color: var(--azul-orcela); font-weight: 800; text-transform: uppercase;">Permiso de Trabajo Peligroso</h2>
    <p class="text-muted">Grupo Industrial Roche - Sistema de Gestión de Seguridad</p>
  </div>

  <form id="formPeligroso">
    <div class="seccion-card">
      <h3>1. Tipo de Permiso</h3>
      <div class="d-flex gap-5 mb-3">
        <div class="form-check"><input class="form-check-input" type="radio" name="p_tipo" value="Diario" checked> <label class="fw-medium">Diario</label></div>
        <div class="form-check"><input class="form-check-input" type="radio" name="p_tipo" value="Por Trabajo"> <label class="fw-medium">Por Trabajo</label></div>
      </div>
      <div class="p-2 px-3 bg-light rounded d-inline-block">
        <span class="text-muted-small">Autorización No:</span> <span id="folio" class="fw-bold text-primary ms-2">AUTOMÁTICO</span>
      </div>
    </div>

    <div class="seccion-card">
      <h3>2. Descripción del Trabajo y/o Actividad</h3>
      <div class="row g-3">
        <div class="col-md-3"><label class="form-label fw-semibold small">Fecha</label><input type="date" class="form-control" name="fecha"></div>
        <div class="col-md-3"><label class="form-label fw-semibold small">Hora Inicio</label><input type="time" class="form-control" name="h_ini" id="h_ini" onchange="calcularTiempo()"></div>
        <div class="col-md-3"><label class="form-label fw-semibold small">Hora Final</label><input type="time" class="form-control" name="h_fin" id="h_fin" onchange="calcularTiempo()"></div>
        <div class="col-md-3"><label class="form-label fw-semibold small">Tiempo Estimado</label><input type="text" class="form-control form-control-readonly" name="t_est" id="t_est" readonly placeholder="Calculado..."></div>
        
        <div class="col-md-6">
          <label class="form-label fw-semibold small">Responsable Elaboración</label>
          <select class="form-select" name="resp_elab" id="resp_elab">
            <option value="">Cargando nombres...</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold small">Responsable Ejecución</label>
          <select class="form-select" name="resp_ejec" id="resp_ejec">
            <option value="">Cargando nombres...</option>
          </select>
        </div>

        <div class="col-md-6">
          <label class="form-label fw-semibold small">Razón social del contratista (si aplica)</label>
          <input type="text" class="form-control" name="razon_social" placeholder="Nombre de la empresa externa">
        </div>
        <div class="col-md-6">
          <label class="form-label fw-semibold small">Departamento/Área donde se realiza el trabajo</label>
          <select class="form-select" name="depto_trabajo" id="depto_trabajo">
             <option value="COSECHA Y CAMPO">COSECHA Y CAMPO</option>
 <option value="LAVADORAS">LAVADORAS</option>
 <option value="MOLINOS Y ENVASADOS">MOLINOS Y ENVASADOS</option>
 <option value="MANT INDUSTRIAL">MANT INDUSTRIAL</option>
 <option value="MANT ESP COLORADAS">MANT ESP COLORADAS</option>
 <option value="EMBARQUES">EMBARQUES</option>
 <option value="CONTROL DE CALIDAD">CONTROL DE CALIDAD</option>
 <option value="OFICINAS">OFICINAS</option>
 <option value="ALMACEN">ALMACEN</option>
 <option value="PRESTACIONES">PRESTACIONES</option>
 <option value="BIOLOGIA Y AQUACULTURA">BIOLOGIA Y AQUACULTURA</option>
 <option value="MANTTO. Y OPERACION MUELLE">MANTTO. Y OPERACION MUELLE</option>
 <option value="REGISTRO">REGISTRO</option>
          </select>
        </div>

        <div class="col-12">
          <label class="form-label fw-semibold small">Ubicación del sitio donde se realizará el trabajo</label>
          <input type="text" class="form-control" name="ubicacion_sitio" placeholder="Ej: Azotea edificio B, Almacén de químicos...">
        </div>

        <div class="col-12">
          <label class="form-label fw-semibold small">Descripción Detallada del Trabajo</label>
          <textarea class="form-control" name="desc_t" rows="3" placeholder="Describa brevemente las tareas a realizar..."></textarea>
        </div>
      </div>
    </div>

    <div class="seccion-card">
      <h3>3. Tipo y característica del trabajo</h3>
      <div class="grid-checklist">
        <label class="check-item"><input type="checkbox" name="tipo_t" value="TCA" onchange="actualizarInterfaz()"> en Caliente (TCA)</label>
        <label class="check-item"><input type="checkbox" name="tipo_t" value="TEL" onchange="actualizarInterfaz()"> Eléctrico (TEL)</label>
        <label class="check-item"><input type="checkbox" name="tipo_t" value="TEX" onchange="actualizarInterfaz()"> Excavación (TEX)</label>
        <label class="check-item"><input type="checkbox" name="tipo_t" value="TEC" onchange="actualizarInterfaz()"> Espacio Confinado (TEC)</label>
        <label class="check-item"><input type="checkbox" name="tipo_t" value="TBU" onchange="actualizarInterfaz()"> Buceo (TBU)</label>
        <label class="check-item"><input type="checkbox" name="tipo_t" value="TIZ" onchange="actualizarInterfaz()"> Izaje de Carga (TIZ)</label>
        <label class="check-item"><input type="checkbox" name="tipo_t" value="TAL" onchange="actualizarInterfaz()"> Altura (TAL)</label>
      </div>
      <input type="text" class="form-control mt-3" name="otros_t" placeholder="Especificar otros riesgos...">
    </div>

    <div class="seccion-card">
      <h3>4. Características del ambiente de trabajo que se presentan al momento de realizar la actividad</h3>
      <div class="grid-checklist">
        <label class="check-item"><input type="checkbox" name="ambiente" value="Ambiente contaminado"> Ambiente contaminado</label>
        <label class="check-item"><input type="checkbox" name="ambiente" value="Ruido excesivo"> Ruido excesivo</label>
        <label class="check-item"><input type="checkbox" name="ambiente" value="Tránsito de vehículos"> Tránsito de vehículos</label>
        <label class="check-item"><input type="checkbox" name="ambiente" value="Exposición al sol"> Exposición al sol</label>
        <label class="check-item"><input type="checkbox" name="ambiente" value="Piso húmedo"> Piso húmedo</label>
        <label class="check-item"><input type="checkbox" name="ambiente" value="Cables expuestos"> Cables expuestos</label>
        <label class="check-item"><input type="checkbox" name="ambiente" value="Tránsito de personas"> Tránsito de personas</label>
        <label class="check-item"><input type="checkbox" name="ambiente" value="Vientos fuertes"> Vientos fuertes</label>
        <label class="check-item"><input type="checkbox" name="ambiente" value="Lluvias"> Lluvias</label>
      </div>
      <div class="mt-3">
        <label class="form-label fw-semibold small">Otros:</label>
        <input type="text" class="form-control" name="otros_ambiente" placeholder="Especifique otras características del ambiente de trabajo...">
      </div>
    </div>

    <div class="seccion-card">
      <h3>5. Riesgos Observados</h3>
      <div class="grid-checklist">
        <label class="check-item"><input type="checkbox" name="riesgos" value="Incendio"> Incendio</label>
        <label class="check-item"><input type="checkbox" name="riesgos" value="Caída de personas"> Caída de personas</label>
        <label class="check-item"><input type="checkbox" name="riesgos" value="Caída de materiales"> Caída de materiales</label>
        <label class="check-item"><input type="checkbox" name="riesgos" value="Intoxicación"> Intoxicación</label>
        <label class="check-item"><input type="checkbox" name="riesgos" value="Explosión"> Explosión</label>
        <label class="check-item"><input type="checkbox" name="riesgos" value="Derrame químico"> Derrame químico</label>
        <label class="check-item"><input type="checkbox" name="riesgos" value="Partículas sólidas"> Partículas sólidas</label>
        <label class="check-item"><input type="checkbox" name="riesgos" value="Choque térmico"> Choque térmico</label>
        <label class="check-item"><input type="checkbox" name="riesgos" value="Deslizamiento"> Deslizamiento</label>
        <label class="check-item"><input type="checkbox" name="riesgos" value="Postura forzada"> Postura forzada</label>
        <label class="check-item"><input type="checkbox" name="riesgos" value="Sobreesfuerzo"> Sobreesfuerzo</label>
        <label class="check-item"><input type="checkbox" name="riesgos" value="Derrumbe"> Derrumbe</label>
        <label class="check-item"><input type="checkbox" name="riesgos" value="Descarga eléctrica"> Descarga eléctrica</label>
      </div>
      <div class="mt-3">
        <label class="form-label fw-semibold small">Otros:</label>
        <input type="text" class="form-control" name="otros_riesgos" placeholder="Especifique otros riesgos...">
      </div>
    </div>

    <div id="secEPP" class="seccion-card hidden">
      <h3>EPP mínimos obligatorios para la protección</h3>
      <p class="text-danger small mb-3 fw-medium">* Validar con Seguridad Industrial según la actividad.</p>
      <div id="contEPP" class="grid-checklist"></div>
    </div>

    <div class="seccion-card">
      <h3>7. Herramientas / Equipos utilizados</h3>
      <div class="grid-checklist">
        <label class="check-item"><input type="checkbox" name="herramientas_check" value="Andamios tipo torre"> Andamios tipo torre o estructura</label>
        <label class="check-item"><input type="checkbox" name="herramientas_check" value="Andamios suspendidos"> Andamios suspendidos</label>
        <label class="check-item"><input type="checkbox" name="herramientas_check" value="Plataformas Elevación"> Plataformas/Equipos de Elevación</label>
        <label class="check-item"><input type="checkbox" name="herramientas_check" value="Escaleras"> Escaleras</label>
        <label class="check-item"><input type="checkbox" name="herramientas_check" value="Medidos Multigases"> Medidos Multigases</label>
        <label class="check-item"><input type="checkbox" name="herramientas_check" value="Amoladora Esmeriladora"> Amoladora Esmeriladora</label>
        <label class="check-item"><input type="checkbox" name="herramientas_check" value="Sierra circular"> Sierra circular</label>
        <label class="check-item"><input type="checkbox" name="herramientas_check" value="Máq. Soldar"> Máq. De soldar eléctrica</label>
        <label class="check-item"><input type="checkbox" name="Máquina Oxicorte"> Máquina Oxicorte</label>
        <label class="check-item"><input type="checkbox" name="herramientas_check" value="Maquinaria Pesada"> Maquinaria Pesada</label>
        <label class="check-item"><input type="checkbox" name="herramientas_check" value="Grúa Móvil"> Grúa Móvil</label>
        <label class="check-item"><input type="checkbox" name="herramientas_check" value="Brazo articulado"> Brazo articulado</label>
        <label class="check-item"><input type="checkbox" name="herramientas_check" value="Side Boom"> Side Boom</label>
        <label class="check-item"><input type="checkbox" name="herramientas_check" value="Martillo Neumático"> Martillo Neumático</label>
      </div>
      <div class="mt-3">
        <label class="form-label fw-semibold small">Otros:</label>
        <input type="text" class="form-control" name="otros_herramientas" placeholder="Especifique otras herramientas o equipos...">
      </div>
    </div>

    <div id="seccion7" class="seccion-card hidden">
      <h3>8. Previsiones mínimas obligatorias para inicio y ejecución del trabajo</h3>
      <div id="contenedorChecklists"></div>
    </div>

    <div class="seccion-card">
      <h3>9. Personal autorizado para la realización del trabajo</h3>
      <div class="row g-3 mb-4">
        <div class="col-sm-9">
          <select class="form-select" id="selPersonal">
            <option value="">Cargando personal...</option>
          </select>
        </div>
        <div class="col-sm-3">
          <button type="button" class="btn btn-outline-primary w-100 h-100" onclick="agregarPersonal()">+ Agregar</button>
        </div>
      </div>
      
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>Nombre Completo</th>
              <th class="text-center" width="100">DC-3</th>
              <th class="text-center" width="100">IMSS</th>
              <th class="text-center" width="80">Acción</th>
            </tr>
          </thead>
          <tbody id="listaPersonal"></tbody>
        </table>
      </div>
    </div>

    <button type="button" class="btn-submit" id="btnSubmit" onclick="registrar()">
      REGISTRAR TRABAJO Y GENERAR PDF
    </button>
  </form>
</div>

<script>
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxVGCAiFS4k-yg5lBFeZkjNGSxUPWoyqqb92628wgaT6gmfbIPDaWuvUPwqBpQcASk5/exec';

  window.onload = function() {
    new TomSelect("#depto_trabajo", {
      create: false,
      sortField: { field: "text", order: "asc" },
      placeholder: "Busca un área...",
      allowEmptyOption: true
    });

    fetch(SCRIPT_URL + "?action=getListasFormulario")
      .then(response => response.json())
      .then(data => {
        if (data.elaboradores) {
          llenarUnSelect('resp_elab', data.elaboradores);
        }
        if (data.personalGeneral) {
          llenarUnSelect('resp_ejec', data.personalGeneral);
          llenarUnSelect('selPersonal', data.personalGeneral);
        }
      })
      .catch(error => {
        console.error('Error al cargar nombres:', error);
      });
  };

  function llenarUnSelect(id, nombres) {
    const sel = document.getElementById(id);
    if(!sel) return;
    nombres.forEach(n => {
      let opt = document.createElement('option');
      opt.value = n;
      opt.textContent = n;
      sel.appendChild(opt);
    });

    if (sel.tomselect) {
      sel.tomselect.destroy();
    }

    new TomSelect("#" + id, {
      create: false,
      sortField: { field: "text", order: "asc" },
      placeholder: "Busca un nombre...",
      allowEmptyOption: true
    });
  }

  function calcularTiempo() {
    const inicio = document.getElementById('h_ini').value;
    const fin = document.getElementById('h_fin').value;
    if (inicio && fin) {
      const [h1, m1] = inicio.split(':').map(Number);
      const [h2, m2] = fin.split(':').map(Number);
      let d1 = new Date(); d1.setHours(h1, m1, 0);
      let d2 = new Date(); d2.setHours(h2, m2, 0);
      if (d2 < d1) d2.setDate(d2.getDate() + 1);
      const difMs = d2 - d1;
      const difHoras = Math.floor(difMs / 3600000);
      const difMinutos = Math.floor((difMs % 3600000) / 60000);
      document.getElementById('t_est').value = `${difHoras} hrs ${difMinutos} min`;
    }
  }

const eppMaster = {
    TCA: ["Casco de seguridad", "Tapones auditivos", "Guantes de carnaza", "Pantalla facial*(validar)", "Mascarilla para soldador*(validar)", "Careta de soldador*(validar)", "Peto de carnaza", "Manga de carnaza*(validar)", "Polainas de carnaza*(validar)", "Overol*(validar)", "Filtros Part. Inorgan/org.*(validar)", "Lentes oxicorte*(validar)", "Monjas*(validar)", "Botas dieléctricas"],
    TIZ: ["Casco de seguridad", "Barbiquejo", "Guantes de carnaza", "Chaleco/Reflejantes", "Botas de seguridad con concha", "Guantes de seguridad de maniobrista"],
    TEL: ["Guantes dieléctricos", "Casco dieléctrico", "Botas dieléctricas"],
    TEX: ["Casco de seguridad", "Tapones auditivos*(validar)", "Conchas de seguridad*(validar)", "Guantes de carnaza*(validar)", "Chaleco/Reflejantes", "Guantes para perforistas*(validar)", "Botas de seguridad con concha", "Filtros Part. Inorgan/Org.", "Lentes de protección partículas"],
    TEC: ["Chaleco/Reflejantes", "Botas de seguridad con concha", "Filtros Part. Inorgan/Org.*(validar)", "Arnés*(validar)", "Línea de vida*(validar)", "Mascarilla respirador 1/2 cara", "Guantes de seguridad de maniobrista"],
    TBU: ["Traje de buceo", "Tanque de aire", "Aletas", "Botas de buceo"],
    TAL: ["Casco de seguridad", "Barbiquejo", "Chaleco/Reflejantes*(validar)", "Botas de seguridad con concha", "Arnés", "Línea de vida"]
  };

  const preguntasMaster = {
  TCA: [
"¿Se encuentra el área delimitada y señalizada?",
"¿Se ha retirado todo material inflamable o combustible en un radio de 10 m o protegido (mampara antichispa o lona ignifuga)?",
"¿El área esta ventilada o cuenta con extractor de gases?",
"¿Cuenta con mampara antichispa o lona ignifuga? Si el trabajo es realizado en espacios compartidos con otras operaciones?",
"¿Cuenta con el extintor tipo PQS?",
"¿La alimentación eléctrica se encuentra en condiciones adecuadas para la conexión de los equipos?",
"¿El equipo de corte y soldadura se encuentra en buenas condiciones?",
"¿Los cables, pinzas y conexiones se encuentran en buenas condiciones y aislados?",
"¿Todas las extensiones eléctricas son de uso rudo para soportar el voltaje y tienen conexión a tierra?"],
  TEL: [
"¿Se verificó desergenización del equipo/circuito?",
"¿Se aplico el bloqueado y candadeo del equipo o intervenir?",
"¿Las extensiones eléctricas cuentan con cable vulcanizado flexible? Si aplica",
"¿Los tableros eléctricos cuentan con sistema efectivo de puesta a tierra con resistencia no mayor a 10 ohmios?",
"¿Los aparatos eléctricos portátiles (amoladora, taladro, cortadora, lámpara, etc) cuentan con doble aislamiento?",
"Área delimitada y señalizada",
"Dispone de extintor de fuego acorde al riesgo (Extintor CO2 o PQS)",
"¿Se verificaron que los circuitos donde se van a conectar los equipos estén puestos a tierra?",
"¿Los mangos y carcazas de aparatos eléctricos portátiles se encuentran en buen estado?",
"¿Los cables eléctricos, tomacorrientes, y enchufes en general en buen estado?",
"¿Los aparatos e instalaciones protegidas del agua o a prueba de agua?",
],
  TEX: [
"¿Se verificó el estado del terreno (fallas, grietas o desprendimiento)?",
"¿Se verificó en los planos la existencia de tuberías, cables eléctricos?",
"¿Las paredes de la excavación cuentan con la protección (atrincherado)?",
"¿Se encuentran los accesos y salidas en buenas condiciones de uso y ubicación? ", 
"¿Se cuenta con escalera de entrada y salida a la excavación?",
"¿La escalera sobresale 90 cm de la excavación?",
"¿En las áreas de paso o transito de trabajadores cuenta con barandas de 90 cm de altura?",
"¿Se cuenta con los elementos necesarios para realizar apuntalamientos donde sea requerido?",
"¿La excavación se encuentra delimitada tomando en cuenta, tránsito de vehículos/colaboradores, ubicación de tubería, ubicación de cables eléctricos, maquinaria o infraestructura?",
"¿ Se colocaron señales de seguridad delimitando la zanja en un radio no menor a 5 metros?",
"¿Se dispone de un espacio suficiente para ubicar el material retirado de la zanja, hoyo o pila? 1 metro de distancia del borde de la excavación?",
"¿Están dispuestos los elementos para rescate en caso de emergencia?",
],
      TEC: [
"¿Se cuenta con un vigia a tiempo completo en la zona de trabajo y con medios de comunicación en condiciones de operación?",
"¿Se verifico el estado físico de la persona antes de entrar (Presion arterial)?",
"¿Se ha asegurado que todos los equipos/líneas de alimentación y salida del espacio confinado han sido bloqueados?",
"¿Se tiene buena iluminación en el sitio de trabajo, y en caso de requerirla es antichispa?",
"¿El espacio confinado se encuentra libre de cualquier material peligroso para los trabajadores?",
"¿Se ha ventilado el espacio confinado?",
"¿Se ha señalizado el lugar con advertencia de ingreso solo personal autorizado?",
"¿Conoce y mantiene las medidas de prevención para los combustibles o sustancias químicas presentes en la atmosfera  (si aplica)?",
"¿Cuenta con las Hojas de Datos de Seguridad en el sitio de trabajo (si aplica)?",
"¿Cuenta con procedimiento y equipo de rescate?",
"¿El ambiente de trabajo requiere de una evaluación de la atmosfera? Si la respuesta es afirmativa, verifique los siguientes valores?",
],
  TIZ: [
"¿Se cuenta con un operador certificado y autorizado para la maniobra de izaje?",
"¿Se ha delimitado y aislado el área de trabajo?",
"¿Se tienen en cuenta las dimensiones (alto, ancho, largo, peso, volumen) del material a movilizar?",
"¿El equipo para el izaje se encuentra sobre una superficie estable, firme y nivelada?",
"¿Se encuentra en buen estado el equipo para realizar e izaje?",
"¿Permiten los factores externos (dirección del viento, condiciones atmosféricas, etc) realizar los trabajos con seguridad?",
"¿No se observan cables, cuerdas, basura, etc. en las áreas adyacentes que puedan presentar dificultad al momento de realizar el trabajo?",
"¿El radio de trabajo de la grúa esta a mas de 3 metros de trabajo?",
"¿Las eslingas, cables y accesorios se encuentran en buen estado?",
"¿La carga a izar se encuentra dentro de la capacidad de carga?",
"¿Se tiene claro un plan de emergencia (rutas de evacuación, ubicación de extintores)?",
],
  TAL: [
"¿Se encuentra acordonada el área de trabajo?",
"¿Se encuentra el área libre de gases, vapores y materiales peligrosos?",
"¿El trabajador manifestó no sufrir mareos, afecciones cardiacas, enfermedades del oído o pérdida del conocimiento?",
"¿Se verifico que la presión arterial de los trabajadores se encuentre dentro de los parámetros para la realización del trabajo?",
"¿El área se encuentra debidamente iluminada?",
"¿El área se encuentra libre de materiales?"
]
  };

  function actualizarInterfaz() {
    const seleccionados = Array.from(document.querySelectorAll('input[name="tipo_t"]:checked')).map(c => c.value);
    const contEPP = document.getElementById("contEPP");
    let eppSet = new Set();
    seleccionados.forEach(t => { if(eppMaster[t]) eppMaster[t].forEach(item => eppSet.add(item)); });
    document.getElementById("secEPP").classList.toggle("hidden", eppSet.size === 0);
    
    contEPP.innerHTML = Array.from(eppSet).map(item => `<label class="check-item"><input type="checkbox" name="epp_check" value="${item}" checked> ${item}</label>`).join('');

    const contenedor = document.getElementById("contenedorChecklists");
    const seccion7 = document.getElementById("seccion7");
    contenedor.innerHTML = "";
    seccion7.classList.toggle("hidden", seleccionados.length === 0);

    seleccionados.forEach(tipo => {
      if(!preguntasMaster[tipo]) return;
      let html = `<div class="mb-5"><h6 class="text-primary fw-bold mb-3">REQUISITOS PARA ${tipo}:</h6>`;
      preguntasMaster[tipo].forEach((preg, i) => {
        html += `<div class="pregunta-row"><span>${preg}</span><div class="d-flex gap-3">
                 <label class="small fw-semibold"><input type="radio" name="${tipo}_${i}" value="SI"> SÍ</label>
                 <label class="small fw-semibold"><input type="radio" name="${tipo}_${i}" value="NO"> NO</label></div></div>`;
      });
      if(tipo === "TEC") html += generarHtmlMonitoreo();
      if(tipo === "TAL") html += generarHtmlSubTAL();
      html += `</div>`;
      contenedor.innerHTML += html;
    });
  }

  function generarHtmlMonitoreo() {
    return `<div class="mt-4 p-4 border-0 rounded bg-light shadow-sm">
            <h6 class="fw-bold text-dark border-bottom pb-2 mb-3">MONITOREO DE ATMOSFERA (TEC)</h6>
            <div class="row g-3">
            <div class="col-md-4"><label class="small fw-bold">O2 (19.5-23.5%)</label><input type="text" class="form-control" name="tec_o2"></div>
            <div class="col-md-4"><label class="small fw-bold">CO (<35 ppm)</label><input type="text" class="form-control" name="tec_co"></div>
            <div class="col-md-4"><label class="small fw-bold">Explosividad (<10%)</label><input type="text" class="form-control" name="tec_expl"></div></div></div>`;
  }

  function generarHtmlSubTAL() {
    return `<div class="mt-4"><h6 class="fw-bold">Equipos específicos de Altura:</h6>
            ${generarSeccionHija('Escaleras Portátiles', 'esc', ['¿Fibra de vidrio?', '¿Buen estado?', '¿Base firme?', '¿3 puntos contacto?'])}
            ${generarSeccionHija('Andamios Estructurales', 'and', ['¿Barandas 90cm?', '¿Rodapiés 10cm?', '¿Nivelados?', '¿Sin corrosión?'])}</div>`;
  }

  function generarSeccionHija(titulo, id, pregs) {
    let sub = `<div class="mb-3 border rounded p-3 bg-white shadow-sm"><div class="d-flex justify-content-between align-items-center mb-2">
               <label class="fw-bold text-secondary">${titulo}:</label>
               <select class="form-select form-select-sm w-auto" onchange="document.getElementById('sub_${id}').classList.toggle('hidden', this.value === 'B')">
               <option value="B">No aplica</option><option value="A">Aplica</option></select></div>
               <div id="sub_${id}" class="sub-seccion hidden">`;
    pregs.forEach((p, i) => {
      sub += `<div class="pregunta-row"><span>${p}</span><div class="d-flex gap-3">
              <label class="small"><input type="radio" name="${id}_${i}" value="SI"> S</label> <label class="small"><input type="radio" name="${id}_${i}" value="NO"> N</label></div></div>`;
    });
    return sub + `</div></div>`;
  }

  function agregarPersonal() {
    const sel = document.getElementById("selPersonal");
    const n = sel.value;
    if(!n) return;
    const tabla = document.getElementById("listaPersonal");
    tabla.innerHTML += `<tr><td class="fw-medium nombre-per">${n}</td>
      <td class="text-center"><input class="form-check-input dc3-per" type="checkbox"></td>
      <td class="text-center"><input class="form-check-input imss-per" type="checkbox"></td>
      <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger" onclick="this.closest('tr').remove()">✕</button></td></tr>`;
    sel.tomselect.clear();
  }

  function registrar() {
    const form = document.getElementById('formPeligroso');
    const btn = document.getElementById('btnSubmit');

    if(!form.fecha.value || !form.resp_elab.value || !form.depto_trabajo.value) {
      alert("Por favor completa los campos obligatorios (Fecha, Responsables y Departamento)");
      return;
    }

    btn.disabled = true;
    btn.innerText = "PROCESANDO DATOS Y GENERANDO PDF...";

    let personalHTML = "";
    const filasPersonal = document.querySelectorAll("#listaPersonal tr");
    
    if(filasPersonal.length === 0) {
      personalHTML = '<tr><td colspan="3" style="border:0.5pt solid black; text-align:center;">Sin personal registrado</td></tr>';
    } else {
      filasPersonal.forEach(tr => {
        let nombre = tr.querySelector(".nombre-per").innerText;
        let dc3 = tr.querySelector(".dc3-per").checked ? "X" : "";
        let imss = tr.querySelector(".imss-per").checked ? "X" : "";
        personalHTML += `<tr>
          <td style="border:0.5pt solid black; padding:3px;">${nombre}</td>
          <td style="border:0.5pt solid black; text-align:center;">${dc3}</td>
          <td style="border:0.5pt solid black; text-align:center;">${imss}</td>
        </tr>`;
      });
    }

    const formData = new FormData(form);
    const params = new URLSearchParams();

    for (const [key, value] of formData.entries()) {
        params.append(key, value);
    }
    params.append("personal_pdf", personalHTML);

    fetch(SCRIPT_URL, { 
      method: 'POST', 
      mode: 'cors', // Cambiado a 'cors' para poder leer la respuesta JSON
      body: params.toString(),
      headers: { "Content-Type": "application/x-www-form-urlencoded" }
    })
    .then(response => response.json()) // Procesamos la respuesta JSON del servidor
    .then(res => {
      if (res.status === "success") {
        // --- LÓGICA DE DESCARGA AUTOMÁTICA ---
        const link = document.createElement('a');
        link.href = res.url;
        link.target = "_blank"; // Asegura compatibilidad
        link.download = "Permiso_PTAR.pdf";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        // -------------------------------------

        alert("¡Registro exitoso! El PDF se ha generado y descargado.");
        
        form.reset();
        document.getElementById('resp_elab').tomselect.clear();
        document.getElementById('resp_ejec').tomselect.clear();
        document.getElementById('selPersonal').tomselect.clear();
        document.getElementById('depto_trabajo').tomselect.clear();
        document.getElementById("listaPersonal").innerHTML = "";
        document.getElementById("t_est").value = "";
        actualizarInterfaz();
      } else {
        alert("Error: " + res.message);
      }
    })
    .catch(error => {
      alert("Error al conectar con el servidor.");
      console.error('Error!', error);
    })
    .finally(() => {
      btn.disabled = false;
      btn.innerText = "REGISTRAR TRABAJO Y GENERAR PDF";
    });
  }
</script>
</body>
</html>
