<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Capitanes - ISYSA</title>
    <style>
        :root { --gold: #c5a021; --navy: #002344; --light: #f1f5f9; --success: #22c55e; --error: #ef4444; --warning: #f59e0b; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; }
        .container { width: 100%; max-width: 600px; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin: auto; border-top: 8px solid var(--gold); overflow: hidden; }
        .header { background: var(--navy); color: white; padding: 20px; text-align: center; }
        .body-content { padding: 25px; }
        .group { margin-bottom: 18px; }
        label { display: block; font-weight: 700; margin-bottom: 6px; color: var(--navy); font-size: 0.85rem; text-transform: uppercase; }
        select, textarea, input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        .info-card { background: var(--light); border: 1px solid #e2e8f0; padding: 20px; border-radius: 8px; margin-top: 20px; display: none; }
        .section-title { border-bottom: 2px solid var(--gold); padding-bottom: 5px; margin-bottom: 15px; color: var(--navy); font-weight: bold; font-size: 1rem; }
        .data-row { margin-bottom: 10px; font-size: 0.9rem; line-height: 1.4; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .data-row b { color: var(--navy); display: block; font-size: 0.75rem; text-transform: uppercase; margin-bottom: 2px; }
        .img-evidencia { width: 100%; border-radius: 8px; margin-top: 10px; border: 2px solid #ddd; display: block; background: #eee; min-height: 150px; object-fit: contain; }
        button { width: 100%; background: var(--navy); color: white; border: none; padding: 14px; font-weight: bold; border-radius: 6px; cursor: pointer; margin-top: 15px; transition: 0.3s; }
        button:hover { background: var(--gold); }
        button:disabled { background: #94a3b8; cursor: not-allowed; }
        .loader { text-align: center; color: var(--gold); font-weight: bold; display: none; padding: 10px; }
        .badge-tipo { padding: 4px 8px; border-radius: 4px; color: white; font-weight: bold; font-size: 0.8rem; display: inline-block; margin-bottom: 10px; }
        
        /* Estilo para la nueva sección de alerta imperativa */
        .alerta-prioridad { background: #fff4e5; border: 1px dashed var(--warning); padding: 15px; border-radius: 8px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div id="loginSection" class="container">
    <div class="header"><h1>Acceso Capitanes</h1></div>
    <div class="body-content">
        <div class="group">
            <label>Seleccione su nombre</label>
            <select id="loginNombre"><option value="">Cargando...</option></select>
        </div>
        <div class="group">
            <label>Código de Acceso</label>
            <input type="password" id="loginPass" placeholder="Contraseña">
        </div>
        <button onclick="intentarLogin()" id="btnLogin">INGRESAR</button>
    </div>
</div>


<div id="mainPanel" class="container" style="display: none;">
    <div class="header"><h1 id="txtBienvenida">Panel</h1></div>
    <div class="body-content">
        <div class="group">
            <label>1. Observador Asignado</label>
            <select id="selectObservador" onchange="cargarReportes()">
                <option value="">-- Seleccione --</option>
            </select>
        </div>
        <div id="loaderRep" class="loader">Buscando reportes...</div>
        <div class="group">
            <label>2. Observaciones Pendientes</label>
            <select id="selectReporte" onchange="mostrarDetalle()" disabled>
                <option value="">Seleccione un observador primero</option>
            </select>
        </div>

        <div id="visorDetalle" class="info-card">
            <div id="badgeCont"></div>
            <div class="section-title">Detalles del Reporte</div>
            <div id="datosVisor"></div>
            <div id="valFoto"></div>
            <hr style="margin: 20px 0; border: 0; border-top: 2px solid var(--gold);">
            <form id="formDictamen">
                <input type="hidden" id="idFila" name="idFila"> 
                

                  <div id="areaCalificacion" class="alerta-prioridad" style="display: none;">
                    <label style="color: var(--warning);">Calificación de Condición</label>
                    <select name="calificacionPrioridad" id="calificacionPrioridad">
                        <option value="INMEDIATO">INMEDIATO</option>
                        <option value="PROGRAMADO">PROGRAMADO</option>
                        <option value="PROXIMO PARO">PRÓXIMO PARO</option>
                    </select>
                </div>

                <label>Veredicto Final</label>
                <select name="dictamen" required>
                    <option value="Validado">Validado (Aprobar)</option>
                    <option value="Corregir">Corregir (Enviar a revisión)</option>
                    <option value="Rechazado">Rechazado</option>
                </select>
                <label style="margin-top:15px;">Comentarios para el Observador</label>
                <textarea name="comentarios" rows="3" placeholder="Indique las razones del veredicto..." required></textarea>
                <button type="submit" id="btnEnviar">GUARDAR Y NOTIFICAR POR CORREO</button>
            </form>
        </div>
    </div>
</div>

<script>
    const MI_URL = "https://script.google.com/macros/s/AKfycbxldLIlq-w2hUaouOIy_mTAlni4xNa88N3gMw9eQFEPByohqAZj1rp0uGSU8Qn-ZoDr/exec";
    let baseDatos = [];

    window.onload = async () => {
        try {
            const resp = await fetch(`${MI_URL}?action=getCapitanes`);
            const data = await resp.json();
            const sel = document.getElementById("loginNombre");
            sel.innerHTML = '<option value="">-- Seleccione --</option>';
            data.capitanes.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
        } catch (e) { console.error("Error", e); }
    };

    async function intentarLogin() {
        const nombre = document.getElementById("loginNombre").value;
        const pass = document.getElementById("loginPass").value;
        if(!nombre || !pass) return alert("Complete los datos");
        const btn = document.getElementById("btnLogin");
        btn.disabled = true; btn.innerText = "VERIFICANDO...";
        try {
            const resp = await fetch(`${MI_URL}?action=login&nombre=${encodeURIComponent(nombre)}&pass=${encodeURIComponent(pass)}`);
            const res = await resp.json();
            if(res.success) {
                document.getElementById("loginSection").style.display = "none";
                document.getElementById("mainPanel").style.display = "block";
                document.getElementById("txtBienvenida").innerText = "Capitán: " + nombre;
                const selObs = document.getElementById("selectObservador");
                res.observadores.forEach(o => selObs.innerHTML += `<option value="${o}">${o}</option>`);
            } else { alert("Error: " + res.message); }
        } catch(e) { alert("Error"); }
        finally { btn.disabled = false; btn.innerText = "INGRESAR"; }
    }

    async function cargarReportes() {
        const obs = document.getElementById("selectObservador").value;
        const selRep = document.getElementById("selectReporte");
        const loader = document.getElementById("loaderRep");
        document.getElementById("visorDetalle").style.display = "none";
        if(!obs) return;
        loader.style.display = "block"; selRep.disabled = true;
        try {
            const resp = await fetch(`${MI_URL}?action=leerTodo&observador=${encodeURIComponent(obs)}`);
            baseDatos = await resp.json();
            selRep.innerHTML = '<option value="">-- Seleccione reporte --</option>';
            if(baseDatos.length > 0) {
                baseDatos.forEach(r => { selRep.innerHTML += `<option value="${r.id}">Sem ${r.semana} - ${r.sitio}</option>`; });
                selRep.disabled = false;
            } else { selRep.innerHTML = '<option value="">Sin reportes pendientes</option>'; }
        } catch(e) { alert("Error al cargar datos"); }
        loader.style.display = "none";
    }

    function crearFila(titulo, valor) {
        if (!valor) return "";
        const valStr = valor.toString().trim().toUpperCase();
        if (valStr === "N/A" || valStr === "" || valStr === "UNDEFINED") return "";
        return `<div class="data-row"><b>${titulo}:</b> ${valor}</div>`;
    }

    function mostrarDetalle() {
        const id = document.getElementById("selectReporte").value;
        const item = baseDatos.find(x => x.id == id);
        if(!item) return;

        document.getElementById("idFila").value = item.id;
        const tipoNormalizado = (item.tipo || "").toLowerCase();
        const esActo = tipoNormalizado.includes("acto");
        const esCondicion = tipoNormalizado.includes("condicion") || tipoNormalizado.includes("condición");

        // LÓGICA DE CALIFICACIÓN (Imperativo/Normal)
        const areaCalificacion = document.getElementById("areaCalificacion");
        if(esCondicion) {
            areaCalificacion.style.display = "block";
        } else {
            areaCalificacion.style.display = "none";
            document.getElementById("calificacionPrioridad").value = "Normal";
        }

        // Badge
        const colorBadge = esActo ? 'var(--navy)' : (esCondicion ? 'var(--error)' : 'var(--gold)');
        document.getElementById("badgeCont").innerHTML = `<span class="badge-tipo" style="background:${colorBadge}">${(item.tipo || "REPORTE").toUpperCase()}</span>`;

        let htmlFinal = "";
        if (esActo) {
            htmlFinal += crearFila("Semana", item.semana);
            htmlFinal += crearFila("Fecha Registro", item.fechaReg);
            htmlFinal += crearFila("Sitio / Ubicación", item.sitio);
            htmlFinal += crearFila("Equipo (EPP) Provisto", item.provisto);
            htmlFinal += crearFila("Equipo (EPP) Faltante", item.faltante);
        } else {
            htmlFinal += crearFila("Semana", item.semana);
            htmlFinal += crearFila("Fecha Registro", item.fechaReg);
            htmlFinal += crearFila("Sitio / Ubicación", item.sitio);
            htmlFinal += crearFila("Responsables", item.responsables);
            htmlFinal += crearFila("Descripción de la Condición", item.condicionDesc);
        }

        document.getElementById("datosVisor").innerHTML = htmlFinal;

        let urlVisualizacion = "";
        const fotoValida = item.foto && item.foto.toString().trim().toUpperCase() !== "N/A";
        if(fotoValida && item.foto.includes("drive.google.com")) {
            const match = item.foto.match(/[-\w]{25,}/);
            if(match) urlVisualizacion = `https://drive.google.com/thumbnail?id=${match[0]}&sz=w1000`;
        }

        const contenedorFoto = document.getElementById("valFoto");
        contenedorFoto.innerHTML = urlVisualizacion ? `<div class="section-title" style="margin-top:20px;">Evidencia Fotográfica</div><a href="${item.foto}" target="_blank"><img src="${urlVisualizacion}" class="img-evidencia"></a>` : "";

        document.getElementById("visorDetalle").style.display = "block";
    }

    document.getElementById("formDictamen").onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById("btnEnviar");
        if(!confirm("¿Confirmar veredicto y notificación?")) return;
        
        btn.disabled = true; btn.innerText = "PROCESANDO...";
        const formData = new FormData(e.target);
        const params = new URLSearchParams(formData);

        try {
            // Se envía 'idFila', 'dictamen', 'comentarios' y 'calificacionPrioridad'
            await fetch(MI_URL, { method: 'POST', body: params, mode: 'no-cors' });
            alert("Veredicto guardado y notificación enviada.");
            document.getElementById("visorDetalle").style.display = "none";
            cargarReportes(); 
        } catch(e) { alert("Error al guardar."); }
        finally { btn.disabled = false; btn.innerText = "GUARDAR Y NOTIFICAR POR CORREO"; }
    };
</script>
</body>
</html>
